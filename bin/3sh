#!/usr/bin/env ruby1.9 -rubygems
$:.unshift(File.expand_path(File.join(File.dirname(__FILE__), '..', 'lib')))
require 'trith'

BANNER = "Usage: #{File.basename($0)} [options] [files...]"

case
  when %w(-V -v --version).any? { |opt| ARGV.include?(opt) }
    $stdout.puts Trith::VERSION.to_s
    exit
  when %w(-? -h --help).any? { |opt| ARGV.include?(opt) }
    $stdout.puts BANNER
    exit
end

begin
  $machine = Trith::Machine.new
  $cache   = Trith::Cache.load_core
  $machine.import!(Trith::Core)
  Trith::Shell.setup!($cache)
  Trith::Shell::History.load!

  while line = Trith::Shell.readline('>> ')
    unless (line = line.strip).empty?
      case line
        when '?', 'help'
          $cache.each_function do |function|
            puts "%-24s%s" % [function.label, function.comment]
          end
          next # skip inspecting the stack
        else
          Trith::Shell::History.push(line)
          begin
            $machine.execute(Trith::Reader.read_all(line))
          rescue Trith::Machine::InvalidOperatorError => e
            $stderr.puts Trith::Shell.format_error(e)
          rescue Trith::Machine::InvalidOperandError => e
            $stderr.puts Trith::Shell.format_error(e)
          rescue Trith::Machine::StackUnderflowError => e
            $stderr.puts Trith::Shell.format_error("stack underflow")
          rescue => e
            $stderr.puts Trith::Shell.format_error(e.inspect)
          end
      end
    end
    $stdout.write '=> '
    $stdout.write Trith::Shell.inspect($machine.stack)
    $stdout.write ' : '
    $stdout.write Trith::Shell.inspect($machine.queue)
    $stdout.puts
  end

  $stdout.puts
  Trith::Shell::History.dump!
rescue Interrupt
  abort '' # abort due to ^C (SIGINT)
end
