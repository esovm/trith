#!/usr/bin/env ruby1.9 -rubygems
$:.unshift(File.expand_path(File.join(File.dirname(__FILE__), '..', 'lib')))
require 'trith'

begin
  $machine = Trith::Machine.new
  $cache   = Trith::Cache.load_core
  Trith::Shell.setup!($cache)
  Trith::Shell::History.load!

  while line = Trith::Shell.readline('>> ')
    unless (line = line.strip).empty?
      case line
        when '?', 'help'
          $cache.each_function do |function|
            puts "%-24s%s" % [function.label, function.comment]
          end
        else
          Trith::Shell::History.push(line)
          begin
            $machine.execute(Trith::Reader.read_all(line))
          rescue Trith::Machine::InvalidOperatorError => e
            $stderr.puts Trith::Shell.format_error(e)
          rescue Trith::Machine::StackUnderflowError => e
            $stderr.puts Trith::Shell.format_error("stack underflow")
          end
          $stdout.puts "=> #{Trith::Shell.inspect($machine.to_a)}"
      end
    end
  end

  Trith::Shell::History.dump!
rescue Interrupt
  # abort due to ^C (SIGINT)
end

$stdout.puts
